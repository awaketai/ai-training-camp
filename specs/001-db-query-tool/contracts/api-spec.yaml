openapi: 3.1.0
info:
  title: Database Query Tool API
  version: 1.0.0
  description: |
    REST API for the database query tool. Allows users to manage database connections,
    retrieve metadata, execute SQL queries, and generate SQL from natural language.

    **Security**: This is a local development tool with no authentication required.

  contact:
    name: Database Query Tool
servers:
  - url: http://localhost:8000/api/v1
    description: Local development server

tags:
  - name: databases
    description: Database connection management
  - name: queries
    description: SQL query execution and generation

paths:
  /databases:
    get:
      tags: [databases]
      operationId: listDatabases
      summary: List all configured databases
      description: Returns a list of all database connections with their current status
      responses:
        '200':
          description: List of databases
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/DatabaseConnection'
                  total:
                    type: integer
                    description: Total number of databases
              example:
                data:
                  - name: "my_mysql_db"
                    connectionUrl: "mysql://user:pass@localhost:3306/mydb"
                    databaseType: "mysql"
                    status: "connected"
                    createdAt: "2025-12-17T10:00:00Z"
                    lastConnectedAt: "2025-12-17T10:05:00Z"
                    lastMetadataRefresh: "2025-12-17T10:05:00Z"
                total: 1

  /databases/{name}:
    parameters:
      - name: name
        in: path
        required: true
        schema:
          type: string
          pattern: '^[a-zA-Z0-9_]+$'
        description: Database name (alphanumeric + underscore)

    get:
      tags: [databases]
      operationId: getDatabase
      summary: Get database details with metadata
      description: Returns database connection details and cached metadata (tables, views, columns)
      responses:
        '200':
          description: Database details with metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  connection:
                    $ref: '#/components/schemas/DatabaseConnection'
                  metadata:
                    $ref: '#/components/schemas/DatabaseMetadata'
        '404':
          description: Database not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [databases]
      operationId: createOrUpdateDatabase
      summary: Add or update a database connection
      description: |
        Creates a new database connection or updates an existing one.
        Automatically connects and extracts metadata.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [connectionUrl]
              properties:
                connectionUrl:
                  type: string
                  description: Database connection URL
                  example: "mysql://user:password@localhost:3306/mydb"
      responses:
        '200':
          description: Database updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatabaseConnection'
        '201':
          description: Database created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatabaseConnection'
        '400':
          description: Invalid connection URL or connection failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [databases]
      operationId: deleteDatabase
      summary: Remove a database connection
      description: Deletes database connection and all cached metadata
      responses:
        '204':
          description: Database deleted successfully
        '404':
          description: Database not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /databases/{name}/metadata/refresh:
    parameters:
      - name: name
        in: path
        required: true
        schema:
          type: string
        description: Database name

    post:
      tags: [databases]
      operationId: refreshMetadata
      summary: Refresh database metadata
      description: Reconnects to database and extracts latest schema information
      responses:
        '200':
          description: Metadata refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatabaseMetadata'
        '404':
          description: Database not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Connection or extraction failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /databases/{name}/query:
    parameters:
      - name: name
        in: path
        required: true
        schema:
          type: string
        description: Database name

    post:
      tags: [queries]
      operationId: executeQuery
      summary: Execute a manual SQL query
      description: |
        Validates and executes a SELECT query against the target database.
        - Only SELECT statements allowed
        - Automatically adds LIMIT 1000 if not present
        - Returns structured results
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sql]
              properties:
                sql:
                  type: string
                  description: SQL SELECT query
                  maxLength: 10000
                  example: "SELECT * FROM users WHERE created_at > '2025-01-01'"
      responses:
        '200':
          description: Query executed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  query:
                    $ref: '#/components/schemas/Query'
                  result:
                    $ref: '#/components/schemas/QueryResult'
              example:
                query:
                  id: "550e8400-e29b-41d4-a716-446655440000"
                  databaseName: "my_mysql_db"
                  sqlText: "SELECT * FROM users"
                  validatedSql: "SELECT * FROM users LIMIT 1000"
                  isValid: true
                  executionStatus: "completed"
                  executedAt: "2025-12-17T10:10:00Z"
                  completedAt: "2025-12-17T10:10:02Z"
                  executionTimeMs: 2000
                  rowCount: 150
                result:
                  queryId: "550e8400-e29b-41d4-a716-446655440000"
                  columns:
                    - name: "id"
                      dataType: "INT"
                    - name: "username"
                      dataType: "VARCHAR(255)"
                  rows:
                    - id: 1
                      username: "alice"
                    - id: 2
                      username: "bob"
                  totalRows: 150
                  executionTimeMs: 2000
                  wasLimited: true
        '400':
          description: Validation error (invalid SQL or non-SELECT statement)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "Only SELECT statements are allowed"
                code: "VALIDATION_ERROR"
                details:
                  statementType: "INSERT"
        '404':
          description: Database not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Query execution failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /databases/{name}/query/natural:
    parameters:
      - name: name
        in: path
        required: true
        schema:
          type: string
        description: Database name

    post:
      tags: [queries]
      operationId: generateSqlFromNaturalLanguage
      summary: Generate SQL from natural language
      description: |
        Uses LLM to generate a SELECT query from a natural language prompt.
        - Includes database metadata as context
        - Validates generated SQL
        - Returns generated SQL (user can review before execution)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [prompt]
              properties:
                prompt:
                  type: string
                  description: Natural language description of data need
                  minLength: 3
                  maxLength: 2000
                  example: "Show me all users who registered in the last 30 days"
      responses:
        '200':
          description: SQL generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NaturalLanguageRequest'
              example:
                id: "660e8400-e29b-41d4-a716-446655440000"
                databaseName: "my_mysql_db"
                prompt: "Show me all users who registered in the last 30 days"
                generatedSql: "SELECT * FROM users WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)"
                generationStatus: "completed"
                createdAt: "2025-12-17T10:15:00Z"
                completedAt: "2025-12-17T10:15:05Z"
                modelUsed: "gpt-4"
                tokensUsed: 350
        '400':
          description: Invalid prompt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Database not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: LLM service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                message: "OpenAI API is currently unavailable"
                code: "LLM_SERVICE_ERROR"
                details:
                  retryAfter: 60

  /health:
    get:
      operationId: healthCheck
      summary: Health check endpoint
      description: Returns service health status
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: "1.0.0"

components:
  schemas:
    DatabaseConnection:
      type: object
      required:
        - name
        - connectionUrl
        - databaseType
        - status
        - createdAt
      properties:
        name:
          type: string
          pattern: '^[a-zA-Z0-9_]+$'
          minLength: 1
          maxLength: 100
        connectionUrl:
          type: string
          description: Database connection URL
        databaseType:
          type: string
          enum: [mysql, postgresql, sqlite]
        status:
          type: string
          enum: [connected, disconnected, error]
        createdAt:
          type: string
          format: date-time
        lastConnectedAt:
          type: string
          format: date-time
          nullable: true
        lastMetadataRefresh:
          type: string
          format: date-time
          nullable: true
        errorMessage:
          type: string
          maxLength: 500
          nullable: true

    DatabaseMetadata:
      type: object
      required:
        - databaseName
        - tables
        - views
        - extractedAt
      properties:
        databaseName:
          type: string
        tables:
          type: array
          items:
            $ref: '#/components/schemas/TableMetadata'
        views:
          type: array
          items:
            $ref: '#/components/schemas/ViewMetadata'
        extractedAt:
          type: string
          format: date-time

    TableMetadata:
      type: object
      required:
        - name
        - columns
      properties:
        name:
          type: string
        schema:
          type: string
          nullable: true
        columns:
          type: array
          items:
            $ref: '#/components/schemas/ColumnMetadata'
        primaryKey:
          type: array
          items:
            type: string
        indexes:
          type: array
          items:
            $ref: '#/components/schemas/IndexMetadata'
        rowCountEstimate:
          type: integer
          nullable: true

    ViewMetadata:
      type: object
      required:
        - name
        - columns
      properties:
        name:
          type: string
        schema:
          type: string
          nullable: true
        columns:
          type: array
          items:
            $ref: '#/components/schemas/ColumnMetadata'
        definition:
          type: string
          nullable: true

    ColumnMetadata:
      type: object
      required:
        - name
        - dataType
        - nullable
        - isPrimaryKey
        - isForeignKey
      properties:
        name:
          type: string
        dataType:
          type: string
        nullable:
          type: boolean
        defaultValue:
          type: string
          nullable: true
        isPrimaryKey:
          type: boolean
        isForeignKey:
          type: boolean
        comment:
          type: string
          nullable: true

    IndexMetadata:
      type: object
      required:
        - name
        - columns
        - isUnique
      properties:
        name:
          type: string
        columns:
          type: array
          items:
            type: string
        isUnique:
          type: boolean
        indexType:
          type: string
          nullable: true

    Query:
      type: object
      required:
        - id
        - databaseName
        - sqlText
        - isValid
        - executionStatus
      properties:
        id:
          type: string
          format: uuid
        databaseName:
          type: string
        sqlText:
          type: string
          maxLength: 10000
        validatedSql:
          type: string
          nullable: true
        isValid:
          type: boolean
        validationError:
          type: string
          nullable: true
        executionStatus:
          type: string
          enum: [pending, running, completed, failed, cancelled]
        executedAt:
          type: string
          format: date-time
          nullable: true
        completedAt:
          type: string
          format: date-time
          nullable: true
        executionTimeMs:
          type: integer
          nullable: true
        rowCount:
          type: integer
          nullable: true
        errorMessage:
          type: string
          maxLength: 1000
          nullable: true

    QueryResult:
      type: object
      required:
        - queryId
        - columns
        - rows
        - totalRows
        - executionTimeMs
        - wasLimited
      properties:
        queryId:
          type: string
          format: uuid
        columns:
          type: array
          items:
            $ref: '#/components/schemas/ColumnDefinition'
        rows:
          type: array
          items:
            type: object
            additionalProperties: true
          maxItems: 1000
        totalRows:
          type: integer
          maximum: 1000
        executionTimeMs:
          type: integer
        wasLimited:
          type: boolean

    ColumnDefinition:
      type: object
      required:
        - name
        - dataType
      properties:
        name:
          type: string
        dataType:
          type: string
        sourceTable:
          type: string
          nullable: true

    NaturalLanguageRequest:
      type: object
      required:
        - id
        - databaseName
        - prompt
        - generationStatus
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        databaseName:
          type: string
        prompt:
          type: string
          minLength: 3
          maxLength: 2000
        generatedSql:
          type: string
          nullable: true
        generationStatus:
          type: string
          enum: [pending, generating, completed, failed]
        errorMessage:
          type: string
          maxLength: 500
          nullable: true
        createdAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        modelUsed:
          type: string
          nullable: true
        tokensUsed:
          type: integer
          nullable: true

    Error:
      type: object
      required:
        - message
        - code
      properties:
        message:
          type: string
          description: User-friendly error message
        code:
          type: string
          description: Error code for programmatic handling
          example: "VALIDATION_ERROR"
        details:
          type: object
          additionalProperties: true
          description: Optional additional error context
          nullable: true
